@model vercom.Models.operacion
@{
    ViewBag.Title = "EDITAR OPEREACION";
    var fecha = Model.fecha.Value.ToString("d");
}
<div class="page-title-head d-flex align-items-center">
    <div class="flex-grow-1">
        <h4 class="fs-sm text-uppercase fw-bold m-0">OPERACION</h4>
    </div>
    <div class="text-end">
        <ol class="breadcrumb m-0 py-0">
            <li class="breadcrumb-item">
                <a href="javascript: void(0);">VERCOM</a>
            </li>
            <li class="breadcrumb-item">
                <a href="javascript: void(0);">OPERACION</a>
            </li>
            <li class="breadcrumb-item active">EDITAR</li>
        </ol>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="card" id="cardProductos">
            <div class="card-header">
                <h4 class="card-title">AGREGAR OPERACIÓN</h4>
            </div>
            <div class="card-body">
                <form role="form" method="post" action="@Url.Action("Edit", "Operacion")">
                    <div class="row g-4">
                        <div class="col-sm-3 border-end border-dashed">
                            <div class="row">
                                @Html.AntiForgeryToken()
                                <div class="mb-3">
                                    <label for="tipo_operacionid" class="form-label">TIPO DE OPERACION </label>
                                    <select class="form-control" name="tipo_operacionid" id="tipo_operacionid">
                                        <option value="@Model.tipo_operacion.id">@Model.tipo_operacion.tipo</option>
                                        @Html.Action("_listoperaciontipo", "Parcial")
                                    </select>
                                    @Html.ValidationMessageFor(model => model.tipo_operacionid)
                                </div>
                                <div class="mb-3" id="tipPago" style="display:none">
                                    <label for="tipo_pagoid" class="form-label">TIPO DE PAGO </label>
                                    <select class="form-control" name="tipo_pagoid" id="tipo_pagoid">
                                        @if (Model.tipo_pago != null)
                                        {
                                            <option value="@Model.tipo_pago.id">@Model.tipo_pago.tipo</option>
                                        }
                                        @Html.Action("_listtipopago", "Parcial")
                                    </select>
                                    @Html.ValidationMessageFor(model => model.tipo_pagoid)
                                </div>
                                <div class="mb-3" id="data_1">
                                    <label for="fecha" class="form-label">FECHA </label>
                                    <div class="input-group date">
                                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span><input type="text" name="fecha" id="fecha" class="form-control" value="@fecha" />
                                    </div>
                                    @Html.ValidationMessageFor(model => model.fecha)
                                </div>
                                <div class="mb-3">
                                    <label for="punto_ventaid" class="form-label">PUNTO DE VENTA </label>
                                    <select class="form-control" name="punto_ventaid" id="punto_ventaid" required="">
                                        <option value="@Model.punto_venta.id">@Model.punto_venta.nombre</option>
                                        @Html.Action("_listapuntos", "Parcial")
                                    </select>
                                    @Html.ValidationMessageFor(model => model.punto_ventaid)
                                </div>                             
                                <div class="d-flex flex-wrap justify-content-between">
                                    <a href="@Url.Action("Index")" class="btn btn-default float-left m-t-n-xs"><i class="fa fa-arrow-left"></i> REGRESAR</a>
                                    <button class="btn btn-primary" type="submit"><strong>ACTUALIZAR</strong></button>
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-6">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">DATOS DEL PRODUCTO</h4>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productoid" class="form-label">PRODUCTO </label>
                                        <select class="form-control" name="productoid" id="productoid">
                                            <option value="@Model.producto.id" selected>@Model.producto.nombre - (@Model.producto.cod)</option>
                                            @Html.Action("_listtproductos", "Parcial")
                                        </select>
                                        @Html.ValidationMessageFor(model => model.productoid)
                                    </div>
                                    <div class="mb-3">
                                        <label for="cantidad" class="form-label">CANTIDAD </label>
                                        <input type="text" class="form-control" id="cantidad" name="cantidad" value="@Model.cantidad" required="">
                                        @Html.ValidationMessageFor(model => model.cantidad)
                                    </div>
                                    <div class="mb-3">
                                        <label for="cantidad" class="form-label">IMPORTE     </label>
                                        <input type="number" step="0.000" value="@Model.importe" name="importe" id="importe" class="form-control" readonly required="" />
                                    </div>
                                </div> <!-- end card-body-->
                            </div> <!-- end card-->
                        </div>
                        <div class="col-xxl-3">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">DATOS GENERALES</h4>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label>CANTIDAD EN PUNTO</label>
                                        <input type="text" name="cantidadp" id="cantidadp" class="form-control" readonly />
                                    </div>
                                    <div class="mb-3">
                                        <label>CANTIDAD RESTANTE</label>
                                        <input type="text" name="cantrest" id="cantrest" class="form-control" readonly />
                                    </div>
                                    <div class="mb-3">
                                        <label>PRECIO</label>
                                        <input type="number" step="0.00" value="@Model.producto.precio" name="precio" id="precio" class="form-control" readonly required="" />
                                    </div>
                                </div> <!-- end card-body-->
                            </div> <!-- end card-->
                        </div>
                    </div> <!-- end row-->
                </form>
            </div> <!-- end card-body-->
            <div class="card-overlay" style="display: none;">
                <div class="d-flex justify-content-center mt-3">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
        </div> <!-- end card-->
    </div> <!-- end col -->
</div>

<form role="form" method="post" action="@Url.Action("Edit", "Operacion")">
</form>

@section Styles {
    <link href="~/Content/plugins/toastr/toastr.min.css" rel="stylesheet" />
    <link href="~/Content/plugins/daterangepicker/daterangepicker.css" rel="stylesheet" />
}


@section Scripts {
    <script src="~/Scripts/plugins/toastr/toastr.min.js"></script>
    <script src="~/Scripts/plugins/moment/moment.min.js"></script>
    <script src="~/Scripts/plugins/daterangepicker/daterangepicker.js"></script>
    <script src="~/Scripts/plugins/choices/choices.min.js"></script>
    <script src="~/Scripts/decimal.js"></script>
    <script>
    $(document).ready(function () {
        inicializarFecha();
        inicializarSelectProductos();
        configurarEventos();
    });

    function inicializarFecha() {
        $('#fecha').daterangepicker({
            singleDatePicker: true,
            showDropdowns: true,
            startDate: moment("@fecha", "DD/MM/YYYY"),
            locale: {
                format: 'DD/MM/YYYY',
                daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                monthNames: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                firstDay: 1
            }
        });
    }

    function inicializarSelectProductos() {
        const selectProductos = document.getElementById('productoid');
        window.choicesProductos = new Choices(selectProductos, {
            shouldSort: false,
            searchEnabled: true,
            itemSelectText: '',
            removeItemButton: false
        });
    }

    function configurarEventos() {
        $('#tipo_operacionid').on('change', mostrarTipoPago);
        $('#punto_ventaid').on('change', actualizarProductosPorPunto);
        $('#productoid').on('change', actualizarProductoSeleccionado);
        $('#cantidad').on('change', calcularImporte);
    }

    function mostrarTipoPago() {
        const tipo = $('#tipo_operacionid').val();
        if (tipo == 2) {
            $('#tipPago').show();
        } else {
            $('#tipo_pagoid').val(null);
            $('#tipPago').hide();
        }
    }

    function actualizarProductosPorPunto() {
        const puntoId = $('#punto_ventaid').val();
        const operTipo = $('#tipo_operacionid').val();
        const fecha = $('#fecha').val();

        if (!puntoId || !operTipo || !fecha) return;

        limpiarCamposProducto();
        choicesProductos.clearChoices();
        choicesProductos.clearStore();

        $.getJSON('@Url.Action("_productosXpunto", "Parcial")',
            { id: puntoId, tipo: operTipo, fecha: fecha },
            function (data) {
                const opciones = data
                    .filter(item => item.id && item.id !== "0")
                    .map((item, i) => ({
                        value: item.id,
                        label: `( ${item.cod} ) - ${item.nombre}`,
                        selected: i === 0,
                        customProperties: {
                            precio: item.precio,
                            cantidad: item.cant_saldo
                        }
                    }));
                choicesProductos.setChoices(opciones, 'value', 'label', true);
            });
    }

    function actualizarProductoSeleccionado() {
        const prodid = $('#productoid').val();
        const operTipo = $('#tipo_operacionid').val();
        const fecha = $('#fecha').val();

        limpiarCamposProducto();

        if (!prodid || !fecha || !operTipo) return;

        $.getJSON('@Url.Action("_productosXpunto", "Parcial")',
            { id: prodid, tipo: operTipo, fecha: fecha },
            function (data) {
                data.forEach(item => {
                    $('#precio').val(item.precio);
                    $('#cantidadp').val(item.cant_saldo);
                });
            });
    }

    function limpiarCamposProducto() {
        $('#precio').val(0);
        $('#cantidadp').val(0);
        $('#cantrest').val(0);
        $('#importe').val(0);
    }

    function calcularImporte() {
        const operacion = $('#tipo_operacionid').val();
        let precio = new Decimal($('#precio').val().replace(",", ".") || 0);
        let cantidad = new Decimal($('#cantidad').val().replace(",", ".") || 0);
        let cantidadp = new Decimal($('#cantidadp').val().replace(",", ".") || 0);
        let importe = precio.mul(cantidad).toNumber();
        let restante = cantidadp.sub(cantidad).toNumber();

        if (cantidadp.equals(0)) {
            $('#cantidadp').val(cantidad.toString());
            $('#cantrest').val(0);
        } else {
            if (operacion == 1) {
                let nuevoSaldo = cantidadp.plus(cantidad).toNumber();
                $('#cantidadp').val(nuevoSaldo);
            } else {
                $('#cantrest').val(restante);
            }
        }

        $('#importe').val(importe);
    }
    </script>
}
