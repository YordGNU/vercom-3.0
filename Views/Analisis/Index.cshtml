@model vercom.Models.operacion
@{
    ViewBag.Title = "ANALISIS";
}
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>ANÁLISIS</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="@Url.Action("Index", "Home")">Inicio</a>
            </li>
            <li class="breadcrumb-item">
                <a href="#">Analisis</a>
            </li>
            <li class="active breadcrumb-item">
                <strong>Operaciones</strong>
            </li>
        </ol>
    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-4">
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>FILTRAR</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-12">
                            @Html.Action("_filterRangeOperacion", "Operacion")
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div id="ajaxLoader" style="display: none">
                <div class="sk-cube-grid">
                    <div class="sk-cube sk-cube1"></div>
                    <div class="sk-cube sk-cube2"></div>
                    <div class="sk-cube sk-cube3"></div>
                    <div class="sk-cube sk-cube4"></div>
                    <div class="sk-cube sk-cube5"></div>
                    <div class="sk-cube sk-cube6"></div>
                    <div class="sk-cube sk-cube7"></div>
                    <div class="sk-cube sk-cube8"></div>
                    <div class="sk-cube sk-cube9"></div>
                </div>
            </div>
            <div class="ibox">
                <div class="ibox-title">
                    <h5>IMPORTE</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">
                        <label id="label_totalImporte"></label>
                    </h1>
                    <div class="stat-percent font-bold text-success">
                        <label id="label_porcienImporte"></label>%
                        <i class="fa fa-bolt"></i>
                    </div>
                    <small>importe total</small>
                </div>
            </div>
            <div class="ibox">
                <div class="ibox-title">
                    <h5>COSTO</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">
                        <label id="label_totalCosto"></label>
                    </h1>
                    <div class="stat-percent font-bold text-info">
                        <label id="label_porcienCosto"></label>%
                        <i class="fa fa-level-up"></i>
                    </div>
                    <small>costo total</small>
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>UTILIDADES</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">
                        <label id="label_utilidades"></label>
                    </h1>
                    <div class="stat-percent font-bold text-info">
                        <label id="label_porcienutilidades"></label>%
                        <i class="fa fa-level-up"></i>
                    </div>
                    <small>utilidades</small>
                </div>
            </div>
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>TIPOS DE PAGO</h5>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-md-6">
                            <h1 class="no-margins">
                                <label id="label_cantEfectivo"></label>
                            </h1>
                            <div class="font-bold text-navy">
                                <label id="label_porcientEfectivo"></label>%
                                <i class="fa fa-level-up"></i>
                                <small>Efectivo</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h1 class="no-margins">
                                <label id="label_cantTransfer"></label>
                            </h1>
                            <div class="font-bold text-navy">
                                <label id="label_porcientTransfer"></label>%
                                <i class="fa fa-level-up"></i>
                                <small>Transferencia</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>DISTRIBUCIÓN POR TIPO DE OPERACION</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="fullscreen-link">
                            <i class="fa fa-expand"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-5 b-r">
                            <div style="width: 100%; padding-left: -0px; ">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover dt-responsive display nowrap DataTable" width="100%" id="dataTable1">
                                        <thead>
                                            <tr>
                                                <th width="100%">OPERACIÓN</th>
                                                <th>CANTIDAD</th>
                                                <th>%</th>
                                                <th>IMPORTE</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                        <div class="col-sm-7">
                            <div class="container" id="chartContainer5">
                                <div id="spinner1" class="spinner-overlay" style="display:none">
                                    <div class="sk-spinner sk-spinner-wave">
                                        <div class="sk-rect1"></div>
                                        <div class="sk-rect2"></div>
                                        <div class="sk-rect3"></div>
                                        <div class="sk-rect4"></div>
                                        <div class="sk-rect5"></div>
                                    </div>
                                </div>
                                <canvas style="width: 100%; padding-left: -0px;" id="canvaForVXoperacion"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>DISTRIBUCIÓN DE OPERACIONES POR FECHA</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="fullscreen-link">
                            <i class="fa fa-expand"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-5 b-r">
                            <div style="width: 100%; padding-left: -0px; ">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover dt-responsive display nowrap DataTable" width="100%" id="dataTable2">
                                        <thead>
                                            <tr>
                                                <th>FECHA</th>
                                                <th>T.OPERACION</th>
                                                <th>CANTIDAD</th>
                                                <th>%</th>
                                                <th>IMPORTE</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-7">
                            <div id="spinner2" class="spinner-overlay" style="display:none">
                                <div class="sk-spinner sk-spinner-wave">
                                    <div class="sk-rect1"></div>
                                    <div class="sk-rect2"></div>
                                    <div class="sk-rect3"></div>
                                    <div class="sk-rect4"></div>
                                    <div class="sk-rect5"></div>
                                </div>
                            </div>
                            <canvas style="width: 100%; padding-left: -0px;" id="canvaForVXfecha"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>DISTRIBUCIÓN DE OPERACIONES POR PUNTO DE VENTA</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="fullscreen-link">
                            <i class="fa fa-expand"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-7 b-r">
                            <div style="width: 100%; padding-left: -0px; ">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover dt-responsive display nowrap DataTable" width="100%" id="dataTable3">
                                        <thead>
                                            <tr>
                                                <th>PUNTO DE VENTA</th>
                                                <th>T.OPERACION</th>
                                                <th>CANTIDAD</th>
                                                <th>%</th>
                                                <th>IMPORTE</th>
                                                <th>COSTO</th>
                                                <th>UTILIDAD</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-5">
                            <div id="spinner3" class="spinner-overlay" style="display:none">
                                <div class="sk-spinner sk-spinner-wave">
                                    <div class="sk-rect1"></div>
                                    <div class="sk-rect2"></div>
                                    <div class="sk-rect3"></div>
                                    <div class="sk-rect4"></div>
                                    <div class="sk-rect5"></div>
                                </div>
                            </div>
                            <canvas style="width: 100%; padding-left: -0px;" id="canvaForVXpunto"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>DISTRIBUCIÓN DE OPERACIONES POR PRODUCTOS</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="fullscreen-link">
                            <i class="fa fa-expand"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-12">
                            <div style="width: 100%; padding-left: -0px; ">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover dt-responsive display nowrap DataTable" width="100%" id="dataTable4">
                                        <thead>
                                            <tr>
                                                <th>CÓDIGO</th>
                                                <th width="30%">PRODUCTO</th>
                                                <th>T.OPERACION</th>
                                                <th>CANT.</th>
                                                <th>UM</th>
                                                <th>%</th>
                                                <th>IMPORTE</th>
                                                <th>COSTO</th>
                                                <th>UTILIDAD</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <div class="chart-container" style="height: 100%">
                                <div id="spinner4" class="spinner-overlay" style="display:none">
                                    <div class="sk-spinner sk-spinner-wave">
                                        <div class="sk-rect1"></div>
                                        <div class="sk-rect2"></div>
                                        <div class="sk-rect3"></div>
                                        <div class="sk-rect4"></div>
                                        <div class="sk-rect5"></div>
                                    </div>
                                </div>
                                <canvas style="width: 100%; padding-left: -0px;" id="canvaForVXproducto"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Styles {
    @Styles.Render("~/plugins/dateRangeStyles")
    @Styles.Render("~/Content/plugins/chosen/chosenStyles")
    @Styles.Render("~/plugins/dataPickerStyles")
    @Styles.Render("~/Content/plugins/ionRangeSlider/ionRangeStyles")
    @Styles.Render("~/Content/plugins/dataTables/dataTablesStyles")
    <style>
        div.dataTables_wrapper div.dataTables_filter input {
            width: 500px;
        }

        .spinner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: none;
        }
    </style>
}

@section Scripts {
    @Scripts.Render("~/plugins/dataPicker")
    @Scripts.Render("~/plugins/ionRange")
    @Scripts.Render("~/plugins/chosen")
    @Scripts.Render("~/plugins/dateRange")
    @Scripts.Render("~/plugins/dataTables")
    <script src="@Url.Content("~/Scripts/plugins/chartJs/chart.js")"></script>
    <script src="@Url.Content("~/Scripts/plugins/chartJs/chartjs-adapter-date-fns.bundle.min.js")"></script>
    <script src="~/Scripts/decimal.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {


            $('#data_5 .input-daterange')
                .datepicker({
                    locale: 'es',
                    keyboardNavigation: false,
                    forceParse: false,
                    format: 'dd/mm/yyyy'
                });

            $('#productoid').chosen({ width: "100%" });

            function getRandomRgb() {
                var num = Math.round(0xffffff * Math.random());
                var r = num >> 10 & 250 ;
                var g = num >> 35 & 250;
                var b = num & 250;
                return 'rgb(' + r + ', ' + g + ', ' + b + ', ' + 0.2 +  ')';
            }

            let graf1;
            let graf2;
            let graf3;
            let graf4;
            let graf5;

           // Base genérico para botones
            const crearBotones = (title, columnas) => [
                {
                    extend: 'excel',
                    text: 'EXP.EXCEL',
                    title,
                },
                {
                    extend: 'print',
                    text: 'IMPRIMIR',
                    title,
                    exportOptions: {
                        orientation: 'landscape',
                        columns: columnas
                    },                   
                }
            ];

            // Lenguaje común
            const lenguajeTabla = {
                "sProcessing": "Procesando...",
                "sLengthMenu": "Mostrar _MENU_ registros",
                "sZeroRecords": "No se encontraron resultados",
                "sEmptyTable": "Ningún dato disponible en esta tabla",
                "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                "sSearch": "Buscar:",
                "sLoadingRecords": "Cargando...",
                "oPaginate": {
                    "sFirst": "Primero",
                    "sLast": "Último",
                    "sNext": "Siguiente",
                    "sPrevious": "Anterior"
                },
                "oAria": {
                    "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                }
            };

            // Configuración base
            const opcionesTabla = (orden, title, columnas) => ({
                pageLength: 25,
                dom: '<"html5buttons"B>lTfgitp',
                header: false,
                info: false,
                paginate: false,
                order: [orden],
                buttons: crearBotones(title, columnas),
                language: lenguajeTabla
            });


            $('#punto_ventaid').on('change',
                function () {
                    var url = '@Url.Action("_productosXpuntoFTdate", "Analisis")';

                    var fechainicio = $('#star').val();
                    var fechafin = $('#end').val();
                    var pventaid = $("#punto_ventaid").val();
                    var categ_prod = $("#cat").val();

                    $('#productoid').empty();
                    $('#productoid').append("<option></option>");
                    $.getJSON(url,
                        { inicio: fechainicio, fin: fechafin, pventa: pventaid, tipo: categ_prod },
                        function (data) {
                            $.each(data,
                                function (i, item) {
                                    $("#productoid").append("<option value=" + item.id + ">" + item.nombre + '- (' + item.cod + ')' + "</option>");
                                });
                            $("#productoid").trigger("chosen:updated");
                        });
                });

            $('#cat').on('change',
                function () {
                    var url = '@Url.Action("_productosXpuntoFTdate", "Analisis")';
                    var fechainicio = $('#star').val();
                    var fechafin = $('#end').val();
                    var pventaid = $("#punto_ventaid").val();
                    var categ_prod = $("#cat").val();

                    $('#productoid').empty();
                    $('#productoid').append("<option></option>");
                    $.getJSON(url,
                        { inicio: fechainicio, fin: fechafin, pventa: pventaid, tipo: categ_prod },
                        function (data) {
                            $.each(data,
                                function (i, item) {
                                    $("#productoid").append("<option value=" + item.id + ">" + item.nombre + '- (' + item.cod + ')' + "</option>");
                                });
                            $("#productoid").trigger("chosen:updated");
                        });
                });

            $('#filterOper').click(async function () {
                try {
                    // Obtener valores de entrada en un solo objeto
                    var parametros = {
                        inicio: $('#star').val(),
                        fin: $('#end').val(),
                        toper: $("#tipo_operacionid").val(),
                        pventa: $("#punto_ventaid").val(),
                        categ: $("#cat").val(),
                        producto: $("#productoid").val(),
                        tpago: $("#tipo_pagoid").val(),
                        area: $("#areaid").val()
                    };

                    // Opciones del gráfico 1
                    var barOptions1 = {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        stacked: false,
                        plugins: {
                            title: {
                            display: true,
                            text: 'Gráfico.1 Distribución por operación(s)'
                        }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                type: 'linear',
                                display: true,
                                position: 'left',
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                // grid line settings
                                grid: {
                                    drawOnChartArea: false, // only want the grid ines for one axis to show up
                                    },
                                 },
                             },
                        };

                    // Opciones del gráfico 2
                    var barOptions2 = {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    stacked: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Gráfico.2 Distribución por fecha(s)'
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            beginAtZero: true,
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    quarter: 'MMM YYYY'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            // grid line settings
                            grid: {
                                drawOnChartArea: false, // only want the grid lines for one axis to show up
                            },
                        },

                    },
                };

                    // Opciones del gráfico 3
                    var barOptions3 = {
                         responsive: true,
                         maintainAspectRatio: false,
                         scaleBeginAtZero: true,
                         plugins: {
                             legend: {
                                 position: 'top',
                                 },
                                 title: {
                            display: true,
                            text: 'Gráfico.3 Distribución por punto(s) de venta'
                          }
                      }
                   };


                    // Opciones del gráfico 4
                    var pieOptions4 = {
                        layout: {
                            padding: {
                                left: 20,
                                right: 20,
                                top: 0,
                                bottom: 50
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Gráfico.4 Distribución por producto(s)'
                        }
                      }
                    };

                    // URLs de los servicios
                    var url1 = '@Url.Action("ChartSxiGeneralData", "Analisis")';
                    var url2 = '@Url.Action("ChartSxTipoOperacionFTdate", "Analisis")';
                    var url3 = '@Url.Action("ChartSxiOperacionXFecha", "Analisis")';
                    var url4 = '@Url.Action("ChartSxiOperacionXpuntoFTdate", "Analisis")';
                    var url5 = '@Url.Action("ChartSxiOperacionXproductoFTdate", "Analisis")';

                    async function obtenerDatos(url, parametros) {
                        const queryParams = new URLSearchParams(parametros).toString();
                        try {
                            let response = await fetch(`${url}?${queryParams}`, { method: "GET" }); // Agregar parámetros a la URL
                            if (!response.ok) throw new Error(`Error en ${url}: ${response.status}`);

                            // Mostrar spinners
                            $("#spinner1").show();
                            $("#spinner2").show();
                            $("#spinner3").show();
                            $("#spinner4").show();

                            // Ocultar canvas si se desea
                            $("#canvaForVXoperacion").hide();
                            $("#canvaForVXfecha").hide();
                            $("#canvaForVXpunto").hide();
                            $("#canvaForVXproducto").hide();

                            return await response.json();
                        } catch (error) {
                            console.error(`Error al obtener datos de ${url}:`, error);
                            return null;
                        }
                    }


                    // Obtener datos en paralelo con async/await
                    const [data1, data2, data3, data4, data5] = await Promise.all([
                        obtenerDatos(url1, parametros),
                        obtenerDatos(url2, parametros),
                        obtenerDatos(url3, parametros),
                        obtenerDatos(url4, parametros),
                        obtenerDatos(url5, parametros),
                    ]);



                    actualizarEtiquetas(data1);
                    actualizarTablaYGrafico(data2, barOptions1, data3, barOptions2, data4, barOptions3, data5, pieOptions4);

                } catch (error) {
                    console.error("Error al obtener los datos:", error);
                }
            });

            // Función para actualizar etiquetas
            function actualizarEtiquetas(data) {
                $('#label_totalImporte').empty();
                $('#label_totalCosto').empty();
                $('#label_utilidades').empty();
                $('#label_cantEfectivo').empty();
                $('#label_porcientEfectivo').empty();
                $('#label_cantTransfer').empty();
                $('#label_porcientTransfer').empty();
                $('#label_porcienImporte').empty();
                $('#label_porcienCosto').empty();
                $('#label_porcienutilidades').empty();

                $.each(data,
                    function (i, item) {

                        $('#label_totalImporte').append(item.importe_venta.toFixed(2));
                        $('#label_porcienImporte').append(item.pcien_importe);

                        $('#label_totalCosto').append(item.costo_venta.toFixed(2));
                        $('#label_porcienCosto').append(item.pcien_costo);

                        $('#label_utilidades').append(item.utilidades.toFixed(2));
                        $('#label_porcienutilidades').append(item.pcien_utilidad);

                        $('#label_cantEfectivo').append(item.tipo_pago[0].cantidad);
                        $('#label_porcientEfectivo').append(item.tipo_pago[0].porciento);


                        $('#label_cantTransfer').append(item.tipo_pago[1].cantidad);
                        $('#label_porcientTransfer').append(item.tipo_pago[1].porciento);
                    });
            }

            // Función para actualizar la tabla y el gráfico
            function actualizarTablaYGrafico(data2, barOptions1, data3, barOptions2, data4, barOptions3, data5, pieOptions4) {


                const exportTitle2 = data2.titulo;
                const exportTitle3 = data3.titulo;
                const exportTitle4 = data4.titulo;
                const exportTitle5 = data5.titulo;

                // Preparar datos para el gráfico 1
                var barData1 = {
                    labels: [],
                    datasets: [
                        {
                            label: "IMPORTE",
                            backgroundColor: [],
                            borderColor: "rgba(47,64,80,0.7)",
                            pointBackgroundColor: "rgba(128,225,127,1)",
                            pointBorderColor: "#fff",
                            data: [],
                            yAxisID: 'y',
                        }, {
                            label: "CANTIDAD",
                            type: 'bar',
                            backgroundColor: [],
                            borderColor: "rgba(35,198,200,0.7)",
                            pointBackgroundColor: "rgba(28,132,198,1)",
                            pointBorderColor: "#fff",
                            data: [],
                            yAxisID: 'y1',
                        }
                        ]
                    };

                // Preparar datos para el gráfico 2
                var barData2 = {
                    labels: [],
                    datasets: [
                        {
                            label: "IMPORTE",
                            backgroundColor: [],
                            borderColor: "rgba(47,64,80,0.7)",
                            pointBackgroundColor: "rgba(128,225,127,1)",
                            pointBorderColor: "#fff",
                            data: [],
                            yAxisID: 'y',
                        }, {
                            label: "CANTIDAD",
                            type: 'bar',
                            backgroundColor: [],
                            borderColor: "rgba(35,198,200,0.7)",
                            pointBackgroundColor: "rgba(28,132,198,1)",
                            pointBorderColor: "#fff",
                            data: [],
                            yAxisID: 'y1',
                        }                        ]
                    };

                // Preparar datos para el gráfico 3
                var barData3 = {
                    labels: [],
                    datasets: [
                        {
                            label: "IMPORTE",
                            backgroundColor: [],
                            pointBorderColor: "#fff",
                            data: []
                        }
                    ]
                };

                // Preparar datos para el gráfico 4
                var pieData4 = {
                    labels: [],
                    datasets: [
                        {
                            label: "PORCIENTO",
                            backgroundColor: [],
                            pointBorderColor: "#fff",
                            data: []
                        }
                    ]
                };

                // Inicializar tabla 1
               const tabla1 = reinicializarDataTable('#dataTable1', [3, "desc"], 'DIST. POR OPERACIÓN(s) ' + exportTitle2, [0, 1, 2, 3]);

                // Inicializar tabla 2

                const tabla2 = reinicializarDataTable('#dataTable2', [0, "desc"], 'DIST. POR FECHA(s) ' + exportTitle3, [0, 1, 2, 3, 4]); 

                // Inicializar tabla 3
                const tabla3 = reinicializarDataTable('#dataTable3', [3, "desc"], 'DIST. POR PUNTO(s) ' + exportTitle4, [0, 1, 2, 3, 4, 5, 6]);                 

                // Inicializar tabla 4
                const tabla4 = reinicializarDataTable('#dataTable4', [3, "desc"], 'DIST. POR PRODUCTO(s) ' + exportTitle5, [0, 1, 2, 3, 4, 5, 6, 7]);                  


                $.each(data2.iData, function (i, item) {
                    var color = getRandomRgb();
                    barData1.labels.push(item.tipo);
                    barData1.datasets[0].data.push(item.importe);
                    barData1.datasets[0].backgroundColor.push(color);
                    barData1.datasets[1].data.push(item.cantidad);
                    barData1.datasets[1].backgroundColor.push(color);
                    tabla1.row.add([
                        `<span style="background-color: ${color}">${item.tipo}</span>`,
                        item.cantidad,
                        `${item.porciento}%`,
                        item.importe
                    ]);
                });
                $("#spinner1").hide();
                $("#canvaForVXoperacion").fadeIn();

                $.each(data3.iData, function (i, item) {
                    var color = getRandomRgb();
                    barData2.labels.push(item.fechaLabel);
                    barData2.datasets[0].data.push(item.importe);
                    barData2.datasets[0].backgroundColor.push(color);
                    barData2.datasets[1].data.push(item.cantidad);
                    barData2.datasets[1].backgroundColor.push(color);
                    tabla2.row.add([
                        `<span style="background-color: ${color}">${item.fecha}</span>`,
                        item.tipo,
                        item.cantidad,
                        `${item.porciento}%`,
                        item.importe
                    ]);
                });
                $("#spinner2").hide();
                $("#canvaForVXfecha").fadeIn();

                $.each(data4.iData, function (i, item) {
                    var color = getRandomRgb();
                    barData3.labels.push(item.punto);
                    barData3.datasets[0].backgroundColor.push(color);
                    barData3.datasets[0].data.push(item.importe);
                    tabla3.row.add([
                        `<span style="background-color: ${color}">${item.punto}</span>`,
                        item.tipo,
                        item.cantidad,
                        `${item.porciento}%`,
                        item.importe,
                        item.costo,
                        item.utilidad
                    ]);
                });
                $("#spinner3").hide();
                $("#canvaForVXpunto").fadeIn();

                $.each(data5.iData, function (i, item) {
                    var color = getRandomRgb();

                    // Convierte y formatea los valores
                    var porciento = parseFloat(item.porciento);
                    porciento = isNaN(porciento) ? 0 : porciento;

                    var importe = parseFloat(item.importe);
                    importe = isNaN(importe) ? 0 : importe;

                    var cantidad = parseFloat(item.cantidad);
                    cantidad = isNaN(cantidad) ? 0 : cantidad;

                    var costo = parseFloat(item.costo);
                    costo = isNaN(costo) ? 0 : costo;

                    var utilidad = parseFloat(item.utilidad);
                    utilidad = isNaN(utilidad) ? 0 : utilidad;

                    // Agregar datos al gráfico y la tabla
                    pieData4.labels.push(item.producto + '(' + porciento.toFixed(2) + '%)');
                    pieData4.datasets[0].backgroundColor.push(color);
                    pieData4.datasets[0].data.push(porciento);

                    tabla4.row.add([
                        `<span style="background-color: ${color}">${item.cod}</span>`,
                        item.producto,
                        item.tipo || 'N/A',
                        cantidad.toFixed(2),
                        item.unidad,
                        `${porciento.toFixed(2)}%`,
                        importe.toFixed(2),
                        costo.toFixed(2),
                        utilidad.toFixed(2)
                    ]);
                });
                $("#spinner4").hide();
                $("#canvaForVXproducto").fadeIn();

                tabla1.draw(); // Redibujar la tabla1 con los nuevos datos
                tabla2.draw(); // Redibujar la tabla2 con los nuevos datos
                tabla3.draw(); // Redibujar la tabla3 con los nuevos datos
                tabla4.draw(); // Redibujar la tabla4 con los nuevos datos

                // Crear gráfico
                var ctx1 = document.getElementById("canvaForVXoperacion").getContext("2d");
                var ctx2 = document.getElementById("canvaForVXfecha").getContext("2d");
                var ctx3 = document.getElementById("canvaForVXpunto").getContext("2d");
                var ctx4 = document.getElementById("canvaForVXproducto").getContext("2d");

                // Verificar si `graf1` está definido antes de destruirlo
                if (window.graf1) {
                    window.graf1.destroy();
                }

                // Verificar si `graf2` está definido antes de destruirlo
                if (window.graf2) {
                    window.graf2.destroy();
                }

                // Verificar si `graf3` está definido antes de destruirlo
                if (window.graf3) {
                    window.graf3.destroy();
                }

                // Verificar si `graf4` está definido antes de destruirlo
                if (window.graf4) {
                    window.graf4.destroy();
                }
               
                window.graf1 = new Chart(ctx1, { type: 'line', data: barData1, options: barOptions1 });
                window.graf2 = new Chart(ctx2, { type: 'line', data: barData2, options: barOptions2 });
                window.graf3 = new Chart(ctx3, { type: 'bar', data: barData3, options: barOptions3 });
                window.graf4 = new Chart(ctx4, { type: 'pie', data: pieData4, options: pieOptions4 });

            }

            function reinicializarDataTable(idTabla, orden, titulo, columnas) {
                if ($.fn.DataTable.isDataTable(idTabla)) {
                    $(idTabla).DataTable().clear().destroy();
                }
                return $(idTabla).DataTable(opcionesTabla(orden, titulo, columnas));
            }

        });

        $(document).ajaxStart(function () {
            $('#ajaxLoader').show();
        });
        $(document).ajaxComplete(function () { $('#ajaxLoader').hide(); });
    </script>
}
